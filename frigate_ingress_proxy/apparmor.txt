#include <tunables/global>

profile frigate_ingress_proxy flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # Capabilities
  capability setgid,
  capability setuid,
  capability dac_override,

  # Nginx specific permissions
  network inet stream,
  network inet6 stream,

  # Filesystem access for S6 and scripts
  /bin/** rix,
  /usr/bin/** rix,
  /sbin/nginx rix,
  /usr/sbin/nginx rix,
  
  # Allow reading config files
  /etc/nginx/** r,
  /tmp/nginx.conf r,
  
  # Writable locations for PID and Temp files
  /tmp/nginx/ r,
  /tmp/nginx/** rwk,
  /tmp/nginx.pid rwk,
  /run/nginx.pid rwk,
  /var/lib/nginx/ r,
  /var/lib/nginx/** rwk,
  
  # Logging
  /dev/stdout rw,
  /dev/stderr rw,
  /dev/tty rw,

  # S6-Overlay and Bashio infrastructure
  /init ix,
  /run/s6/** rwk,
  /run/s6-rc*/** rwk,
  /run/service/** rwk,
  /usr/lib/bashio/** r,
  /data/options.json r,

  # This fixes the "initgroups" error
  # It allows the process to manage its own system identity
  signal (receive) peer=unconfined,
  ptrace (trace) peer=unconfined,
}
