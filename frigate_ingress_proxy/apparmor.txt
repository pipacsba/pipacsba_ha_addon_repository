#include <tunables/global>

# Profile name MUST match the slug in config.yaml
profile frigate_ingress_proxy flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # Capabilities required for S6-Overlay and Nginx
  capability setgid,
  capability setuid,
  capability dac_override,
  capability net_bind_service,
  capability chown,
  capability fowner,

  # Network access for the proxy
  network inet stream,
  network inet6 stream,

  # S6-Overlay core execution (Fixes the /run/s6 and suexec errors)
  /init rix,
  /bin/** rix,
  /usr/bin/** rix,
  /sbin/nginx rix,
  /usr/sbin/nginx rix,
  /package/** rix,
  /command/** rix,

  # Allow execution of your startup script
  /run.sh r,

  # Writable locations for S6 runtime and Nginx
  /run/s6/ r,
  /run/s6/** rwk,
  /run/s6-rc*/** rwk,
  /run/service/ r,
  /run/service/** rwk,
  /run/nginx.pid rwk,
  
  # Temporary and Config files
  /tmp/ r,
  /tmp/** rwk,
  /etc/nginx/** r,

  # Nginx internal fallback paths (Fixes the Permission Denied on error.log)
  /var/lib/nginx/ r,
  /var/lib/nginx/** rwk,
  /var/log/nginx/ r,
  /var/log/nginx/** rwk,

  # Logging and System
  /dev/stdout rw,
  /dev/stderr rw,
  /dev/tty rw,
  /dev/null rw,

  # Bashio and Options
  /usr/lib/bashio/** r,
  /data/options.json r,

  # Process management signals
  signal (receive) peer=unconfined,
  ptrace (trace) peer=unconfined,
}
